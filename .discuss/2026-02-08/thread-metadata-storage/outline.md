# Thread Metadata Storage Design

## üîµ Current Focus
- None (discussion complete, ready for decision documentation)

## ‚ö™ Pending
- None

## ‚úÖ Confirmed
- **Storage Solution**: JSON file, not database
  - File location: `.leslie/thread_relations.json`
  - Data scale: Up to 100 threads
  - Agent reads file autonomously, dynamically writes query code
  - Requires versioning (`"version": "1.0"`)
  
- **CLI Tech Stack**:
  - Language: Node.js + TypeScript
  - File lock: Use high-quality npm package (e.g., `proper-lockfile`)
  
- **Data to Store**:
  - Thread basic information (ID, title, created time, status, etc.)
  - CLI operation records (spawn/reference/freeze, etc., with parameters)
  - Thread relationships (for dependency queries)
  - Tags (optional, non-required, provided by agent when invoking CLI)
  
- **JSON Schema Structure**:
  - `version`: Version number
  - `metadata`: Meta information (last update time, thread count)
  - `threads`: Thread basic information dictionary
  - `operations`: Operations history array (CLI command level)
  - `relations`: Relationship cache (derived from operations)
  
- **Dependency Relationships**:
  - Manual marking: User explicitly declares dependencies via CLI
  - Actual source: CLI parameters generated by agent, so it's agent marking
  - Granularity: CLI command level operations
  
- **Agent Integration**:
  - Via AGENTS.md: Brief mention of purpose and skill reference
  - Via Skill (thread-relations): Detailed query guidance
  
- **Skill Design**:
  - Structure: Modular with support files (ÊñπÊ°à2: ÊòéÁ°ÆÂàÜÂ∑•)
    - SKILL.md: Core entry point (~60 lines)
    - references/schema.md: JSON schema documentation
    - references/quick-reference.md: Fast query cheatsheet (Python & JavaScript)
    - references/patterns.md: 6 real-world query patterns
  - Design: No code duplication between files
  - Emphasis: Read-only skill, cannot edit JSON file (all modifications by Leslie CLI)
  - Queries don't need file locks (read-only operations)
  - Location: `.discuss/2026-02-08/thread-metadata-storage/skill-draft/`
  
- **AGENTS.md Content**:
  - Injection timing: During `leslie init` operation
  - Location: "Leslie System" section (after Cross-Thread Reference)
  - Style: Concise but accurate; Only mention skill, let agent load details as needed
  - Template updated: `.discuss/2026-02-04/claude-code-asset-management/templates/leslie-system-guide.md`
  
- **Thread Context Integration**:
  - Added `relations_file` attribute to `<thread_context>` root element
  - Agent discovers file path dynamically (not hardcoded)
  - Template updated: `.discuss/2026-02-04/claude-code-asset-management/templates/thread-context-format.md`
  
- **Concurrency Handling**: 
  - CLI writes with file lock (exclusive lock)
  - Agent reads without lock or with shared lock (optional)
  
- **Documentation Language**: English

## ‚ùå Rejected
- Relational databases (SQLite/PostgreSQL) - Over-engineering, YAGNI
- Automatic dependency inference - Use manual marking (via CLI)
