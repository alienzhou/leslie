# Transcript Format and Generation

> **Decision ID**: D04  
> **Status**: ✅ Confirmed  
> **Last Updated**: 2026-02-09

## 1. Overview

Transcripts are human-readable execution traces auto-generated by Leslie CLI after each conversation ends.

## 2. Format Choice

**Format**: Plain text (.txt), not JSON

**Rationale**:
- Human-readable: Easy to scan and understand
- Agent-friendly: Can be read directly with `read_file` tool
- Compact: More space-efficient than structured JSON
- Proven: Already validated in production (ide-agent)

## 3. File Naming Convention

```
{YYYYMMDD}-{HHmm}-{sanitized-user-query}.txt
```

**Example**: `20260208-1430-fix-login-bug.txt`

### 3.1 Sanitization Rules

| Rule | Description |
|------|-------------|
| Whitelist | Letters, numbers, CJK characters, hyphens, underscores |
| Replace | Other characters with hyphens |
| Max length | 50 characters |
| Fallback | "task" if result is empty |

**Example**:
- Input: `帮我修复这个bug：TypeError: Cannot read property 'name' of undefined!!!`
- Output: `20260208-1545-帮我修复这个bug-TypeError-Cannot-read-pr.txt`

## 4. File Content Structure

```
Thread ID: {threadId}
Chat ID: {chatId}
Time Range: {startTime} ~ {endTime}
Agent Mode: {agentMode}
Stop Reason: {stopReason}
Tool Calls: {toolCallCount}
---

user:
<user_query>
{user message}
</user_query>

assistant:
{assistant response}

[Tool call] {toolName}
{truncated params}

[Tool result] {toolName}
{truncated result}
```

### 4.1 Metadata Header Fields

| Field | Description | Example |
|-------|-------------|---------|
| Thread ID | Thread identifier | `thread-abc123` |
| Chat ID | Chat session identifier | `chat-xyz789` |
| Time Range | ISO timestamps | `2026-02-08T14:30:00+08:00 ~ 2026-02-08T14:45:00+08:00` |
| Agent Mode | Execution mode | `agent`, `plan`, `duet`, `review` |
| Stop Reason | Completion reason | `end_turn`, `max_tokens`, `cancelled` |
| Tool Calls | Number of tool calls | `15` |

### 4.2 Message Formatting Rules

| Message Type | Format |
|--------------|--------|
| User message | `user:`<br>`<user_query>`<br>`{text}`<br>`</user_query>` |
| Assistant text | `assistant:`<br>`{text}` |
| Tool call | `[Tool call] {toolName}`<br>`{truncated params}` |
| Tool result | `[Tool result] {toolName}`<br>`{truncated result}` |
| Error | `[Error]`<br>`{error message}` |

## 5. Conversation Unit Grouping

One transcript file = One conversation unit:
- **Starts**: User message
- **Includes**: All Agent responses, tool calls, tool results
- **Ends**: Before next user message or conversation end

## 6. Truncation Limits

| Content Type | Limit |
|--------------|-------|
| Tool params | 200 chars |
| Tool results | 200 chars |
| Total file size | 20KB |
| Filename query | 50 chars |

## 7. Storage Location

```
.leslie/threads/<thread-id>/.meta/transcripts/
```

## 8. File Cleanup

| Aspect | Policy |
|--------|--------|
| Max files | 50 per Thread |
| Cleanup | Delete oldest when exceeding limit |
| Sorting | Files naturally sort by timestamp in filename |

## 9. Generation Mechanism

### 9.1 Timing

After Thread execution completes (conversation ends).

### 9.2 Method

CLI programmatically generates from Message List:
- Under ACP integration, Leslie can directly access conversation history
- Process termination = accurate signal

### 9.3 Why Not Agent-Generated?

| Approach | Pros | Cons |
|----------|------|------|
| Agent tool call | Flexible | High cost, slow |
| CLI generation | No token cost, fast | Less flexible |

**Decision**: CLI generation (no Agent token consumption, format fully controllable)

## 10. Example Transcript

**Filename**: `20260208-1430-implement-user-login.txt`

```
Thread ID: thread-abc123
Chat ID: chat-xyz789
Time Range: 2026-02-08T14:30:00+08:00 ~ 2026-02-08T14:35:00+08:00
Agent Mode: agent
Stop Reason: end_turn
Tool Calls: 5
---

user:
<user_query>
Implement user login functionality
</user_query>

assistant:
I'll help you implement user login. Let me check the project structure first.

[Tool call] list_files
{"path": "src"}

[Tool result] list_files
src/
├── components/
├── pages/
└── utils/

assistant:
I see the structure. Let me create the login component.

[Tool call] write_to_file
{"path": "src/components/Login.tsx", "content": "..."}

[Tool result] write_to_file
File created successfully

assistant:
Login component created successfully.
```

## 11. Related Documents

- [Asset Types](./01-asset-types.md)
- [Context Injection](./02-context-injection.md)
